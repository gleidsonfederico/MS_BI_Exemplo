/*
Deployment script for DW_SUCOS

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "DW_SUCOS"
:setvar DefaultFilePrefix "DW_SUCOS"
:setvar DefaultDataPath "D:\SqlErver2019\MSSQL15.MSSQLSERVER2019\MSSQL\DATA\"
:setvar DefaultLogPath "D:\SqlErver2019\MSSQL15.MSSQLSERVER2019\MSSQL\DATA\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Rename refactoring operation with key f291415f-1e83-4545-a0e4-afbd6ca031a8 is skipped, element [dbo].[FATO_001].[Id] (SqlSimpleColumn) will not be renamed to Cod_Cliente';


GO
PRINT N'Rename refactoring operation with key 9f160c92-3f72-40ac-82cc-e0589a2c43a7 is skipped, element [dbo].[FATO_001].[Faturamentp] (SqlSimpleColumn) will not be renamed to Faturamento';


GO
PRINT N'Rename refactoring operation with key cabb3e12-344b-48a7-a8f0-ab6f3f4db034 is skipped, element [dbo].[FATO_001].[Impos] (SqlSimpleColumn) will not be renamed to Imposto';


GO
PRINT N'Creating [dbo].[FATO_001]...';


GO
CREATE TABLE [dbo].[FATO_001] (
    [Cod_Cliente]        NVARCHAR (50) NOT NULL,
    [Cod_Produto]        NVARCHAR (50) NOT NULL,
    [Cod_Organizacional] NVARCHAR (50) NOT NULL,
    [Cod_Fabrica]        NVARCHAR (50) NOT NULL,
    [Cod_Dia]            NVARCHAR (50) NOT NULL,
    [Faturamento]        FLOAT (53)    NULL,
    [Imposto]            FLOAT (53)    NULL,
    [Custo_Variavel]     FLOAT (53)    NULL,
    [Quantidade]         FLOAT (53)    NULL,
    [Unidades_Vendidas]  FLOAT (53)    NULL,
    PRIMARY KEY CLUSTERED ([Cod_Dia] ASC, [Cod_Cliente] ASC, [Cod_Produto] ASC, [Cod_Organizacional] ASC, [Cod_Fabrica] ASC)
);


GO
PRINT N'Creating [dbo].[FATO_002]...';


GO
CREATE TABLE [dbo].[FATO_002] (
    [Cod_Cliente] NVARCHAR (50) NOT NULL,
    [Cod_Produto] NVARCHAR (50) NOT NULL,
    [Cod_Fabrica] NVARCHAR (50) NOT NULL,
    [Cod_Dia]     NVARCHAR (50) NOT NULL,
    [Frete]       FLOAT (53)    NULL,
    PRIMARY KEY CLUSTERED ([Cod_Dia] ASC, [Cod_Cliente] ASC, [Cod_Produto] ASC, [Cod_Fabrica] ASC)
);


GO
PRINT N'Creating [dbo].[FATO_003]...';


GO
CREATE TABLE [dbo].[FATO_003] (
    [Cod_Fabrica] NVARCHAR (50) NOT NULL,
    [Cod_Dia]     NVARCHAR (50) NOT NULL,
    [Custo_Fixo]  FLOAT (53)    NULL,
    PRIMARY KEY CLUSTERED ([Cod_Dia] ASC, [Cod_Fabrica] ASC)
);


GO
PRINT N'Creating [dbo].[FATO_004]...';


GO
CREATE TABLE [dbo].[FATO_004] (
    [Cod_Cliente]        NVARCHAR (50) NOT NULL,
    [Cod_Produto]        NVARCHAR (50) NOT NULL,
    [Cod_Organizacional] NVARCHAR (50) NOT NULL,
    [Cod_Dia]            NVARCHAR (50) NOT NULL,
    [Meta_Faturamento]   FLOAT (53)    NULL,
    PRIMARY KEY CLUSTERED ([Cod_Dia] ASC, [Cod_Cliente] ASC, [Cod_Produto] ASC, [Cod_Organizacional] ASC)
);


GO
PRINT N'Creating [dbo].[FATO_005]...';


GO
CREATE TABLE [dbo].[FATO_005] (
    [Cod_Produto] NVARCHAR (50) NOT NULL,
    [Cod_Fabrica] NVARCHAR (50) NOT NULL,
    [Cod_Dia]     NVARCHAR (50) NOT NULL,
    [Meta_Custo]  FLOAT (53)    NULL,
    PRIMARY KEY CLUSTERED ([Cod_Dia] ASC, [Cod_Produto] ASC, [Cod_Fabrica] ASC)
);


GO
PRINT N'Creating [dbo].[FK_FATO_001_DIM_Cliente]...';


GO
ALTER TABLE [dbo].[FATO_001] WITH NOCHECK
    ADD CONSTRAINT [FK_FATO_001_DIM_Cliente] FOREIGN KEY ([Cod_Cliente]) REFERENCES [dbo].[Dim_Cliente] ([Cod_Cliente]);


GO
PRINT N'Creating [dbo].[FK_FATO_001_DIM_Produto]...';


GO
ALTER TABLE [dbo].[FATO_001] WITH NOCHECK
    ADD CONSTRAINT [FK_FATO_001_DIM_Produto] FOREIGN KEY ([Cod_Produto]) REFERENCES [dbo].[DIM_Produto] ([Cod_Produto]);


GO
PRINT N'Creating [dbo].[FK_FATO_001_DIM_Organizacional]...';


GO
ALTER TABLE [dbo].[FATO_001] WITH NOCHECK
    ADD CONSTRAINT [FK_FATO_001_DIM_Organizacional] FOREIGN KEY ([Cod_Organizacional]) REFERENCES [dbo].[DIM_Organizacional] ([Cod_Filho]);


GO
PRINT N'Creating [dbo].[FK_FATO_001_DIM_Fabrica]...';


GO
ALTER TABLE [dbo].[FATO_001] WITH NOCHECK
    ADD CONSTRAINT [FK_FATO_001_DIM_Fabrica] FOREIGN KEY ([Cod_Fabrica]) REFERENCES [dbo].[DIM_Fabrica] ([Cod_Fabrica]);


GO
PRINT N'Creating [dbo].[FK_FATO_001_DIM_Tempo]...';


GO
ALTER TABLE [dbo].[FATO_001] WITH NOCHECK
    ADD CONSTRAINT [FK_FATO_001_DIM_Tempo] FOREIGN KEY ([Cod_Dia]) REFERENCES [dbo].[DIM_Tempo] ([Cod_Dia]);


GO
PRINT N'Creating [dbo].[FK_FATO_002_DIM_Cliente]...';


GO
ALTER TABLE [dbo].[FATO_002] WITH NOCHECK
    ADD CONSTRAINT [FK_FATO_002_DIM_Cliente] FOREIGN KEY ([Cod_Cliente]) REFERENCES [dbo].[Dim_Cliente] ([Cod_Cliente]);


GO
PRINT N'Creating [dbo].[FK_FATO_002_DIM_Produto]...';


GO
ALTER TABLE [dbo].[FATO_002] WITH NOCHECK
    ADD CONSTRAINT [FK_FATO_002_DIM_Produto] FOREIGN KEY ([Cod_Produto]) REFERENCES [dbo].[DIM_Produto] ([Cod_Produto]);


GO
PRINT N'Creating [dbo].[FK_FATO_002_DIM_Fabrica]...';


GO
ALTER TABLE [dbo].[FATO_002] WITH NOCHECK
    ADD CONSTRAINT [FK_FATO_002_DIM_Fabrica] FOREIGN KEY ([Cod_Fabrica]) REFERENCES [dbo].[DIM_Fabrica] ([Cod_Fabrica]);


GO
PRINT N'Creating [dbo].[FK_FATO_002_DIM_Tempo]...';


GO
ALTER TABLE [dbo].[FATO_002] WITH NOCHECK
    ADD CONSTRAINT [FK_FATO_002_DIM_Tempo] FOREIGN KEY ([Cod_Dia]) REFERENCES [dbo].[DIM_Tempo] ([Cod_Dia]);


GO
PRINT N'Creating [dbo].[FK_FATO_003_DIM_Fabrica]...';


GO
ALTER TABLE [dbo].[FATO_003] WITH NOCHECK
    ADD CONSTRAINT [FK_FATO_003_DIM_Fabrica] FOREIGN KEY ([Cod_Fabrica]) REFERENCES [dbo].[DIM_Fabrica] ([Cod_Fabrica]);


GO
PRINT N'Creating [dbo].[FK_FATO_003_DIM_Tempo]...';


GO
ALTER TABLE [dbo].[FATO_003] WITH NOCHECK
    ADD CONSTRAINT [FK_FATO_003_DIM_Tempo] FOREIGN KEY ([Cod_Dia]) REFERENCES [dbo].[DIM_Tempo] ([Cod_Dia]);


GO
PRINT N'Creating [dbo].[FK_FATO_004_DIM_Cliente]...';


GO
ALTER TABLE [dbo].[FATO_004] WITH NOCHECK
    ADD CONSTRAINT [FK_FATO_004_DIM_Cliente] FOREIGN KEY ([Cod_Cliente]) REFERENCES [dbo].[Dim_Cliente] ([Cod_Cliente]);


GO
PRINT N'Creating [dbo].[FK_FATO_004_DIM_Produto]...';


GO
ALTER TABLE [dbo].[FATO_004] WITH NOCHECK
    ADD CONSTRAINT [FK_FATO_004_DIM_Produto] FOREIGN KEY ([Cod_Produto]) REFERENCES [dbo].[DIM_Produto] ([Cod_Produto]);


GO
PRINT N'Creating [dbo].[FK_FATO_004_DIM_Organizacional]...';


GO
ALTER TABLE [dbo].[FATO_004] WITH NOCHECK
    ADD CONSTRAINT [FK_FATO_004_DIM_Organizacional] FOREIGN KEY ([Cod_Organizacional]) REFERENCES [dbo].[DIM_Organizacional] ([Cod_Filho]);


GO
PRINT N'Creating [dbo].[FK_FATO_004_DIM_Tempo]...';


GO
ALTER TABLE [dbo].[FATO_004] WITH NOCHECK
    ADD CONSTRAINT [FK_FATO_004_DIM_Tempo] FOREIGN KEY ([Cod_Dia]) REFERENCES [dbo].[DIM_Tempo] ([Cod_Dia]);


GO
PRINT N'Creating [dbo].[FK_FATO_005_DIM_Produto]...';


GO
ALTER TABLE [dbo].[FATO_005] WITH NOCHECK
    ADD CONSTRAINT [FK_FATO_005_DIM_Produto] FOREIGN KEY ([Cod_Produto]) REFERENCES [dbo].[DIM_Produto] ([Cod_Produto]);


GO
PRINT N'Creating [dbo].[FK_FATO_005_DIM_Fabrica]...';


GO
ALTER TABLE [dbo].[FATO_005] WITH NOCHECK
    ADD CONSTRAINT [FK_FATO_005_DIM_Fabrica] FOREIGN KEY ([Cod_Fabrica]) REFERENCES [dbo].[DIM_Fabrica] ([Cod_Fabrica]);


GO
PRINT N'Creating [dbo].[FK_FATO_005_DIM_Tempo]...';


GO
ALTER TABLE [dbo].[FATO_005] WITH NOCHECK
    ADD CONSTRAINT [FK_FATO_005_DIM_Tempo] FOREIGN KEY ([Cod_Dia]) REFERENCES [dbo].[DIM_Tempo] ([Cod_Dia]);


GO
-- Refactoring step to update target server with deployed transaction logs
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'f291415f-1e83-4545-a0e4-afbd6ca031a8')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('f291415f-1e83-4545-a0e4-afbd6ca031a8')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = '9f160c92-3f72-40ac-82cc-e0589a2c43a7')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('9f160c92-3f72-40ac-82cc-e0589a2c43a7')
IF NOT EXISTS (SELECT OperationKey FROM [dbo].[__RefactorLog] WHERE OperationKey = 'cabb3e12-344b-48a7-a8f0-ab6f3f4db034')
INSERT INTO [dbo].[__RefactorLog] (OperationKey) values ('cabb3e12-344b-48a7-a8f0-ab6f3f4db034')

GO

GO
PRINT N'Checking existing data against newly created constraints';


GO
USE [$(DatabaseName)];


GO
ALTER TABLE [dbo].[FATO_001] WITH CHECK CHECK CONSTRAINT [FK_FATO_001_DIM_Cliente];

ALTER TABLE [dbo].[FATO_001] WITH CHECK CHECK CONSTRAINT [FK_FATO_001_DIM_Produto];

ALTER TABLE [dbo].[FATO_001] WITH CHECK CHECK CONSTRAINT [FK_FATO_001_DIM_Organizacional];

ALTER TABLE [dbo].[FATO_001] WITH CHECK CHECK CONSTRAINT [FK_FATO_001_DIM_Fabrica];

ALTER TABLE [dbo].[FATO_001] WITH CHECK CHECK CONSTRAINT [FK_FATO_001_DIM_Tempo];

ALTER TABLE [dbo].[FATO_002] WITH CHECK CHECK CONSTRAINT [FK_FATO_002_DIM_Cliente];

ALTER TABLE [dbo].[FATO_002] WITH CHECK CHECK CONSTRAINT [FK_FATO_002_DIM_Produto];

ALTER TABLE [dbo].[FATO_002] WITH CHECK CHECK CONSTRAINT [FK_FATO_002_DIM_Fabrica];

ALTER TABLE [dbo].[FATO_002] WITH CHECK CHECK CONSTRAINT [FK_FATO_002_DIM_Tempo];

ALTER TABLE [dbo].[FATO_003] WITH CHECK CHECK CONSTRAINT [FK_FATO_003_DIM_Fabrica];

ALTER TABLE [dbo].[FATO_003] WITH CHECK CHECK CONSTRAINT [FK_FATO_003_DIM_Tempo];

ALTER TABLE [dbo].[FATO_004] WITH CHECK CHECK CONSTRAINT [FK_FATO_004_DIM_Cliente];

ALTER TABLE [dbo].[FATO_004] WITH CHECK CHECK CONSTRAINT [FK_FATO_004_DIM_Produto];

ALTER TABLE [dbo].[FATO_004] WITH CHECK CHECK CONSTRAINT [FK_FATO_004_DIM_Organizacional];

ALTER TABLE [dbo].[FATO_004] WITH CHECK CHECK CONSTRAINT [FK_FATO_004_DIM_Tempo];

ALTER TABLE [dbo].[FATO_005] WITH CHECK CHECK CONSTRAINT [FK_FATO_005_DIM_Produto];

ALTER TABLE [dbo].[FATO_005] WITH CHECK CHECK CONSTRAINT [FK_FATO_005_DIM_Fabrica];

ALTER TABLE [dbo].[FATO_005] WITH CHECK CHECK CONSTRAINT [FK_FATO_005_DIM_Tempo];


GO
PRINT N'Update complete.';


GO
